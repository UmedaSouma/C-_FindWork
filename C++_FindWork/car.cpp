//===========================================================================================================================================================
// 
// 車のベース処理 [car.cpp]
// Author : souma umeda
// 
//===========================================================================================================================================================
#include "car.h"

//========================================================================================================================
// コンストラクタ
//========================================================================================================================
CCar::CCar()
{
	// パラメーターの設定

	m_Param.fWeight = MAX_WEIGHT;
	m_Param.nMaxGear = MAX_GEAR;
	m_Param.fBending = MAX_BENDING;
	m_Param.nMaxLife = MAX_LIFE;

	for (int i = 0; i < m_Param.nMaxGear; i++)
	{
		m_Param.fMaxSpeed[i] = MAX_SPEED[i];
	}

	m_type = CParamStorage::CAR_NORMAL;
	m_fAccumulationSpeed = 0.0f;
}

//========================================================================================================================
// デストラクタ
//========================================================================================================================
CCar::~CCar()
{
}

//========================================================================================================================
// 初期設定
//========================================================================================================================
HRESULT CCar::Init()
{
	InitType();

	CActor::Init();

	return S_OK;
}

//========================================================================================================================
// 終了処理
//========================================================================================================================
void CCar::Uninit()
{
	CActor::Uninit();
}

//========================================================================================================================
// 更新処理
//========================================================================================================================
void CCar::Update()
{
	D3DXVECTOR3 move = GetMove();
	D3DXVECTOR3 copymove = GetMove();
	D3DXVECTOR3 normalize = { 1.0f,1.0f,1.0f };
	//m_fAccumulationSpeed = move.x + move.z;

	if (move.x < 0.0f)
	{
		normalize.x = -1;
	}
	if (move.z < 0.0f)
	{
		normalize.z = -1;
	}

	copymove.x= copymove.x* normalize.x;
	copymove.z= copymove.z* normalize.z;

	m_fAccumulationSpeed = sqrtf(copymove.x * copymove.x + copymove.z * copymove.z);
	
	// 速度が過去の速度より上がっていなかったら
	if (m_oldmove.z >= move.z)
	{
		move.x += -1 * (move.x * 0.01f);
		move.z += -1 * (move.z * 0.01f);
	}

	m_oldmove = move;


	SetMove(move);

	CActor::Update();
}

//========================================================================================================================
// 描画処理
//========================================================================================================================
void CCar::Draw()
{
	CActor::Draw();
}

//===========================================================================================================
// タイプごとの初期設定
//===========================================================================================================
void CCar::InitType()
{
	switch (m_type)
	{
	case CParamStorage::CAR_NORMAL:

		SetModel("data\\model\\car_normal_000.x");	// モデルを設定

		break;

	case CParamStorage::CAR_TRACK:

		break;

	case CParamStorage::CAR_SPORTS:

		SetModel("data\\model\\car_sample.x");	// モデルを設定

		break;

	default:
		break;
	}
}

//===========================================================================================================
// アクセル処理
//===========================================================================================================
void CCar::ActionAccele()
{
	D3DXVECTOR3 move = GetMove();

	if (move.z < 150.0f)
	{
		move.x += sinf(GetRot().y) * 0.5f;
		move.z += cosf(GetRot().y) * 0.5f;
		//move.z += 0.5f;

		//m_fAccumulationSpeed += 0.5f;
	}

	SetMove({ move.x,0.0f,move.z });
}

//===========================================================================================================
// ブレーキ処理
//===========================================================================================================
void CCar::ActionBrake()
{
	D3DXVECTOR3 move = GetMove();

	move.x += sinf(GetRot().y) * -0.1f;
	move.z += cosf(GetRot().y) * -0.1f;

	m_fAccumulationSpeed += -0.1f;

	SetMove({ move.x,0.0f,move.z });
}

//===========================================================================================================
// カーブ処理
//===========================================================================================================
void CCar::ActionBend_R()
{
	D3DXVECTOR3 rot = GetRot();
	
	rot.y += 0.05f;
	SetRot(rot);
}

//===========================================================================================================
// カーブ処理
//===========================================================================================================
void CCar::ActionBend_L()
{
	D3DXVECTOR3 rot = GetRot();

	rot.y += -0.05f;
	SetRot(rot);
}

//===========================================================================================================
// ブースト処理
//===========================================================================================================
void CCar::ActionBoost()
{
}

//========================================================================================================================
// 生成処理
//========================================================================================================================
CCar* CCar::Create()
{
	CCar* pCar = new CCar;

	pCar->Init();

	return pCar;
}